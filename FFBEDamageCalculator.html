<html>
    <head>
        <title>FFBE Damage Calculator</title>
        <script>
            function calculateAttack(unitAttack, buffs, debuffs, nonbreakableATK) {
                var unitAttackCalculation = 0
                if (buffs != null || !isNaN(buffs)) {
                    if (buffs != 0) {
                        unitAttackCalculation = unitAttack + (unitAttack * (buffs/100))
                    } else {
                        unitAttackCalculation = unitAttack;
                    }
                    console.log(`After buffs: ${unitAttackCalculation}`)
                } else {
                    throw("Buff is not a number.")
                }

                if (debuffs != null || !isNan(debuffs)){
                    if (debuffs !=0) {
                        unitAttackCalculation = unitAttackCalculation - (unitAttack * (debuffs/100))
                    }
                    console.log(`After debuffs: ${unitAttackCalculation}`)
                } else {
                    throw ("Debuff is not a number.")
                }

                if (nonbreakableATK != null || !isNan(nonbreakableATK)){
                    if (nonbreakableATK !=0) {
                        unitAttackCalculation = unitAttackCalculation + nonbreakableATK
                    }
                    console.log(`After adding back unbreakable attack: ${unitAttackCalculation}`)
                } else {
                    throw ("Nonbreakable attack is not a number.")
                }

                return unitAttackCalculation
            }

            function calculateDefense(targetDefense, targetDefenseBuffs, targetDefenseDebuffs, ignoreArmor) {
                var baseDefense
                var targetDefenseCalculation = 0;

                if (targetDefense != null && !isNaN(targetDefense)){
                    if (targetDefense != 0) {
                        baseDefense = targetDefense
                    } else {
                        throw("Cannot use a base defense of 0.")
                    }
                }

                if (targetDefenseDebuffs != null && !isNaN(targetDefenseDebuffs) && targetDefenseBuffs != null && !isNaN(targetDefenseBuffs)) {
                    targetDefenseCalculation = baseDefense * ((100-(targetDefenseDebuffs - targetDefenseBuffs)) / 100) * ((100 - ignoreArmor)/100)
                }

                return targetDefenseCalculation
            }

            function levelCorrection(attackerLevel) {
                var levelCorrection = 1 + (attackerLevel / 100)

                return levelCorrection
            }

            function collectData() {
                console.log("Collecting Data...")
                var unitAttack
                var buffs
                var debuffs
                var nonbreakableATK
                var abilityModifier
                var ignoreArmor
                var attackerLevel
                var targetDefense
                var targetDefenseBuffs
                var targetDefenseDebuffs
                var totalAtk
                var totalDefense
                var levelCorrectionResult
                var physicalMitigation
                var magicalMitigation
                var generalMitigation
                var damageType
                var defend

                if (isNaN(document.getElementById("ATK").value) || document.getElementById("ATK").value.length < 1) {
                    throw("Boss attack must be an integer.")
                } else {
                    unitAttack = parseInt(document.getElementById("ATK").value)
                }

                if (isNaN(document.getElementById("nonbreakableATK").value) || document.getElementById("nonbreakableATK").value.length < 1) {
                    throw("Boss nonbreakable attack must be an integer.")
                } else {
                    nonbreakableATK = parseInt(document.getElementById("nonbreakableATK").value)
                }
                
                if (isNaN(document.getElementById("buffs").value) || document.getElementById("buffs").value.length < 1) {
                    throw("Attack buffs must be an integer.")
                } else {
                    buffs = parseInt(document.getElementById("buffs").value)
                }

                if (isNaN(document.getElementById("debuffs").value) || document.getElementById("debuffs").value.length < 1) {
                    throw("Attack debuffs must be an integer.")
                } else {
                    debuffs = parseInt(document.getElementById("debuffs").value)
                }

                if (isNaN(document.getElementById("abilityModifier").value) || document.getElementById("abilityModifier").value.length < 1) {
                    throw("Ability modifier must be an integer.")
                } else {
                    abilityModifier = parseInt(document.getElementById("abilityModifier").value)
                }

                if (isNaN(document.getElementById("ignoreArmor").value) || document.getElementById("ignoreArmor").value.length < 1) {
                    throw("Ignore armor must be an integer.")
                } else {
                    ignoreArmor = parseInt(document.getElementById("ignoreArmor").value)
                }

                if (isNaN(document.getElementById("attackerLevel").value) || document.getElementById("attackerLevel").value.length < 1) {
                    throw("Attacker level must be an integer.")
                } else {
                    attackerLevel = parseInt(document.getElementById("attackerLevel").value)
                }

                if (isNaN(document.getElementById("targetDefense").value) || document.getElementById("targetDefense").value.length < 1) {
                    throw("Target defense must be an integer.")
                } else {
                    targetDefense = parseInt(document.getElementById("targetDefense").value)
                }

                if (isNaN(document.getElementById("targetDefenseBuffs").value) || document.getElementById("targetDefenseBuffs").value.length < 1) {
                    throw("Target defense buffs must be an integer.")
                } else {
                    targetDefenseBuffs = parseInt(document.getElementById("targetDefenseBuffs").value)
                }

                if (isNaN(document.getElementById("targetDefenseDebuffs").value) || document.getElementById("targetDefenseDebuffs").value.length < 1) {
                    throw("Target defense debuffs must be an integer.")
                } else {
                    targetDefenseDebuffs = parseInt(document.getElementById("targetDefenseDebuffs").value)
                }

                if (isNaN(document.getElementById("physicalMitigation").value) || document.getElementById("physicalMitigation").value.length < 1) {
                    throw("Physical mitigation must be an integer.")
                } else {
                    physicalMitigation = parseInt(document.getElementById("physicalMitigation").value)
                }

                if (isNaN(document.getElementById("magicalMitigation").value) || document.getElementById("magicalMitigation").value.length < 1) {
                    throw("Magical mitigation must be an integer.")
                } else {
                    magicalMitigation = parseInt(document.getElementById("magicalMitigation").value)
                }

                if (isNaN(document.getElementById("generalMitigation").value) || document.getElementById("generalMitigation").value.length < 1) {
                    throw("General mitigation must be an integer.")
                } else {
                    generalMitigation = parseInt(document.getElementById("generalMitigation").value)
                }

                console.log("Selected Damage Type " + document.getElementById("damageDropdown").value)
                var selection = document.getElementById("damageDropdown").value

                if (selection == "selectDamageType") {
                    throw("Please select a damage type.")
                } else if (selection == "physicalDamage") {
                    damageType = selection
                } else if (selection == "magicalDamage") {
                    damageType = selection
                } else if (selection == "fixedDamage") {
                    damageType = selection
                }

                if (document.getElementById("defendCheckbox").checked) {
                    defend = true
                } else {
                    defend = false
                }
                console.log("Defending (True/False): " + defend)

                // console.log(unitAttack)
                // console.log(nonbreakableATK)
                // console.log(buffs)
                // console.log(debuffs)
                // console.log(abilityModifier)
                // console.log(attackerLevel)
                // console.log(targetDefense)
                // console.log(targetDefenseBuffs)
                // console.log(targetDefenseDebuffs)
                // console.log(abilityModifier)
                // console.log(attackerLevel)
                // console.log(physicalMitigation)
                // console.log(magicalMitigation)
                // console.log(generalMitigation)

                if (unitAttack != null && nonbreakableATK != null && buffs != null && debuffs != null) {
                    console.log("Calculating ATK...")
                    totalAtk = calculateAttack(unitAttack, buffs, debuffs, nonbreakableATK)
                }

                console.log(totalAtk)

                if (targetDefense != null && targetDefenseBuffs != null && targetDefenseDebuffs != null && ignoreArmor != null) {
                    console.log("Calculating DEF...")
                    totalDefense = calculateDefense(targetDefense, targetDefenseBuffs, targetDefenseDebuffs, ignoreArmor)
                }

                console.log(totalDefense)

                if (attackerLevel !=null) {
                    levelCorrectionResult = levelCorrection(attackerLevel)
                }

                console.log(levelCorrectionResult)

                physicalDamageCalculation(totalAtk, totalDefense, abilityModifier, levelCorrectionResult, 1, 1, physicalMitigation, magicalMitigation, generalMitigation, damageType, defend)
            }

            function physicalDamageCalculation(unitAttack, enemyDefense, modifier, levelCorrection, weaponVariance, finalVariance, physicalMitigation, magicalMitigation, generalMitigation, damageType, defend) {
                var totalMitigation
                
                if (damageType == "physicalDamage" || damageType == "magicalDamage") {
                    console.log(`Calculating damage for combo mitigations.`)
                    if (generalMitigation != null) {
                        if (physicalMitigation > 0) {
                            totalMitigation = (generalMitigation * physicalMitigation) / 100
                        } else if (magicalMitigation != null) {
                            totalMitigation = (generalMitigation * magicalMitigation) / 100
                        }
                    } else {
                        if (physicalMitigation > 0) {
                            totalMitigation = physicalMitigation / 100
                        } else if (magicalMitigation != null) {
                            totalMitigation = magicalMitigation / 100
                        }
                    }
                } else if (damageType == "fixedDamage") {
                    console.log("Using general mitigation for fixed damage.")
                    totalMitigation = 1 - (generalMitigation / 100)
                }
                
                if (totalMitigation == 0) {
                    totalMitigation = 1;
                }

                if (defend == true) {
                    var highestDamage = (((unitAttack * unitAttack) / enemyDefense) * modifier * levelCorrection * weaponVariance * finalVariance * totalMitigation) * 0.5
                    var averageDamage = (((unitAttack * unitAttack) / enemyDefense) * modifier * levelCorrection * weaponVariance * 0.925 * totalMitigation) * 0.5
                    var lowestDamage = (((unitAttack * unitAttack) / enemyDefense) * modifier * levelCorrection * weaponVariance * 0.85 * totalMitigation) * 0.5
                } else {
                    var highestDamage = ((unitAttack * unitAttack) / enemyDefense) * modifier * levelCorrection * weaponVariance * finalVariance * totalMitigation
                    var averageDamage = ((unitAttack * unitAttack) / enemyDefense) * modifier * levelCorrection * weaponVariance * 0.925 * totalMitigation
                    var lowestDamage = ((unitAttack * unitAttack) / enemyDefense) * modifier * levelCorrection * weaponVariance * 0.85 * totalMitigation   
                }

                console.log(`Highest Damage: ${highestDamage}`)
                console.log(`Average Damage: ${averageDamage}`)
                console.log(`Lowest Damage: ${lowestDamage}`)
            }

            function populateSelection() {
                console.log("Selected Boss " + document.getElementById("dropdown").value)
                var selection = document.getElementById("dropdown").value

                if (selection == "Alpherg") {
                    document.getElementById("ATK").value = "500"
                    document.getElementById("nonbreakableATK").value = "250"
                    document.getElementById("attackerLevel").value = "99"
                } else if (selection == "MachinaOfDestructionScorn") {
                    document.getElementById("ATK").value = "1500"
                    document.getElementById("debuffs").value = "70"
                    document.getElementById("nonbreakableATK").value = "900"
                    document.getElementById("attackerLevel").value = "99"
                    document.getElementById("abilityModifier").value = "2.6"
                }
            }
        </script>
        <style>
            layout {
                display: flex;
                flex-direction: column;
            }

            .horizontal {
                display: flex;
                flex-direction: row;
            }

            .horizontal > label {
                padding-right: 20px;
                padding-bottom: 20px;
                width: 200px;
            }

            .horizontal > input, .horizontal > select {
                height: 25px;
                text-align: right;
            }
        </style>
    </head>
    <body>
        <div id="layout">
            <div class="horizontal">
                <label for="dropdown">Bosses</label>
                <select id="dropdown" onchange="populateSelection()">
                    <option value="Select Boss">Select A Boss</option>
                    <option value="Alpherg">Alpherg</option>
                    <option value="MachinaOfDestructionScorn">Machina of Destruction (Scorn)</option>
                </select>
            </div>
            <div class="horizontal">
                <label for="ATK">Attacker ATK before buffs: </label>
                <input id="ATK" value="0"/>
            </div>
            <div class="horizontal">
                <label for="buffs">Attacker ATK buff %:</label>
                <input id="buffs" value="0"/>
            </div>
            <div class="horizontal">
                <label for="debuffs">Attacker ATK debuff %:</label>
                <input id="debuffs" value="0"/>
            </div>
            <div class="horizontal">
                <label for="nonbreakableATK">Attacker Not breakable ATK amount:</label>
                <input id="nonbreakableATK" value="0"/>
            </div>
            <div class="horizontal">
                <label for="abilityModifier">Attacker ability modifier:</label>
                <input id="abilityModifier" value="0"/>
            </div>
            <div class="horizontal">
                <label for="ignoreArmor">Ability ignore armor %:</label>
                <input id="ignoreArmor" value="0"/>
            </div>
            <div class="horizontal">
                    <label for="attackerLevel">Attacker level:</label>
                    <input id="attackerLevel" value="0"/>
                </div>
            <div class="horizontal">
                <label for="targetDefense">Target Defense:</label>
                <input id="targetDefense" value="0"/>
            </div>
            <div class="horizontal">
                <label for="targetDefenseBuffs">Target Defense buff %:</label>
                <input id="targetDefenseBuffs" value="0"/>
            </div>
            <div class="horizontal">
                <label for="targetDefenseDebuffs">Target Defense debuff %:</label>
                <input id="targetDefenseDebuffs" value="0"/>
            </div>
            <div class="horizontal">
                <label for="physicalMitigation">Physical Mitigation:</label>
                <input id="physicalMitigation" value="0"/>
            </div>
            <div class="horizontal">
                <label for="magicalMitigation">Magical Mitigation:</label>
                <input id="magicalMitigation" value="0"/>
            </div>
            <div class="horizontal">
                <label for="generalMitigation">General Mitigation:</label>
                <input id="generalMitigation" value="0"/>
            </div>
            <div class="horizontal">
                <label for="damageDropdown">Damage Type</label>
                <select id="damageDropdown" onchange="populateSelection()">
                    <option value="selectDamageType">Select damage type</option>
                    <option value="physicalDamage">Physical Damage</option>
                    <option value="magicalDamage">Magical Damage</option>
                    <option value="fixedDamage">Fixed Damage</option>
                </select>
            </div>
            <div class="horizontal">
                <label for="defend">Defend</label>
                <input type="checkbox" name="defendCheckbox" id="defendCheckbox">
            </div>
            <div id="submit">
                <button id="submit_button" onClick="collectData()">Submit</button>
            </div>
        </div>
    </body>
</html>